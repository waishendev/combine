# ---------- Stage 1: PHP 扩展 ----------
FROM php:8.2-fpm-alpine AS php-extensions
WORKDIR /var/www

# 运行期依赖
# 运行期依赖（加 ffmpeg）
# 添加 edge 仓库以获取 ffmpeg
RUN echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories && \
    apk update

# 安装基础依赖
# 注意：我们使用自定义字体，不需要系统字体包
RUN apk add --no-cache \
    icu-libs \
    libzip \
    libpng \
    oniguruma \
    postgresql-libs \
    fontconfig \
    libx11 \
    libxext \
    libxrender \
    libstdc++ \
    libgcc \
    openssl \
    openssl-dev \
    ffmpeg && \
    mkdir -p /var/cache/fontconfig && \
    chmod -R 755 /var/cache/fontconfig

# 安装 wkhtmltopdf
# 从 GitHub 下载静态二进制文件（适用于 Alpine Linux）
# 注意：Alpine 使用 musl libc，需要静态编译版本或安装兼容层
RUN set -eux; \
    echo "Installing wkhtmltopdf..."; \
    apk add --no-cache curl tar xz; \
    echo "Installing glibc compatibility for Alpine (needed for wkhtmltopdf)..."; \
    apk add --no-cache gcompat || \
    (echo "gcompat not in main repo, trying edge..." && \
     echo "http://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories && \
     apk update && \
     apk add --no-cache gcompat) || \
    (echo "WARNING: gcompat not available, binary may not work" && true); \
    cd /tmp && \
    if [ -f /var/www/wkhtmltopdf.tar.xz ]; then \
        echo "Using local wkhtmltopdf file..."; \
        cp /var/www/wkhtmltopdf.tar.xz wkhtmltopdf.tar.xz; \
    else \
        echo "Downloading wkhtmltopdf from GitHub..."; \
        curl -fSL "https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.4/wkhtmltox-0.12.4_linux-generic-amd64.tar.xz" \
             --output wkhtmltopdf.tar.xz \
             --fail \
             --location \
             --max-time 300 \
             --retry 3 \
             --retry-delay 5 \
             --show-error || \
        (echo "First URL failed, trying alternative..." && \
         curl -fSL "https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.static-amd64.tar.xz" \
              --output wkhtmltopdf.tar.xz \
              --fail \
              --location \
              --max-time 300 \
              --retry 3 \
              --retry-delay 5 \
              --show-error); \
    fi; \
    if [ ! -f /tmp/wkhtmltopdf.tar.xz ] || [ ! -s /tmp/wkhtmltopdf.tar.xz ]; then \
        echo "ERROR: Failed to download wkhtmltopdf"; \
        echo "Please download manually and place as wkhtmltopdf.tar.xz in project root"; \
        exit 1; \
    fi; \
    echo "Extracting wkhtmltopdf (size: $(du -h /tmp/wkhtmltopdf.tar.xz | cut -f1))..."; \
    tar -xJf wkhtmltopdf.tar.xz 2>/dev/null || tar -xf wkhtmltopdf.tar.xz || (echo "ERROR: Extraction failed" && exit 1); \
    if [ -d wkhtmltox ]; then \
        echo "Copying wkhtmltox to /usr/local..."; \
        cp -r wkhtmltox /usr/local/; \
        echo "Verifying files..."; \
        ls -la /usr/local/wkhtmltox/bin/ || true; \
        if [ -f /usr/local/wkhtmltox/bin/wkhtmltopdf ]; then \
            chmod +x /usr/local/wkhtmltox/bin/wkhtmltopdf; \
            echo "Binary found at /usr/local/wkhtmltox/bin/wkhtmltopdf"; \
            echo "Checking binary type..."; \
            file /usr/local/wkhtmltox/bin/wkhtmltopdf || true; \
            ldd /usr/local/wkhtmltox/bin/wkhtmltopdf 2>&1 | head -5 || echo "Binary may be statically linked or incompatible"; \
        else \
            echo "ERROR: Binary not found, searching..."; \
            find /usr/local/wkhtmltox -name wkhtmltopdf -type f || true; \
            exit 1; \
        fi; \
        echo "Setting up wrapper script..."; \
        echo '#!/bin/sh' > /usr/local/bin/wkhtmltopdf-wrapper; \
        if [ -d /usr/local/wkhtmltox/lib ]; then \
            echo 'export LD_LIBRARY_PATH=/usr/local/wkhtmltox/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        fi; \
        echo 'export FONTCONFIG_CACHEDIR="${FONTCONFIG_CACHEDIR:-/var/cache/fontconfig}"' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'export QT_QPA_PLATFORM=offscreen' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'export FONTCONFIG_FILE=/etc/fonts/fonts.conf' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo '# Suppress fontconfig cache warnings - we use custom fonts via @font-face' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'export FC_DEBUG=0' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'BINARY="/usr/local/wkhtmltox/bin/wkhtmltopdf"' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'if [ ! -f "$BINARY" ]; then' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo '  echo "ERROR: wkhtmltopdf binary not found at $BINARY" >&2' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo '  exit 127' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'fi' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo '# Note: SSL warnings from wkhtmltopdf can be ignored (it uses old OpenSSL but works fine for local HTML->PDF)' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'if command -v gcompat >/dev/null 2>&1; then' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo '  exec gcompat "$BINARY" "$@"' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'else' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo '  exec "$BINARY" "$@"' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        echo 'fi' >> /usr/local/bin/wkhtmltopdf-wrapper; \
        chmod +x /usr/local/bin/wkhtmltopdf-wrapper; \
        ln -sf /usr/local/bin/wkhtmltopdf-wrapper /usr/bin/wkhtmltopdf; \
        ln -sf /usr/local/bin/wkhtmltopdf-wrapper /usr/local/bin/wkhtmltopdf; \
    else \
        echo "ERROR: wkhtmltox directory not found after extraction"; \
        ls -la /tmp/; \
        exit 1; \
    fi; \
    rm -rf /tmp/wkhtmltopdf.tar.xz /tmp/wkhtmltox*; \
    echo "Testing installation..."; \
    (LD_LIBRARY_PATH=/usr/local/wkhtmltox/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH} /usr/local/wkhtmltox/bin/wkhtmltopdf --version || \
     /usr/local/bin/wkhtmltopdf --version || \
     (echo "WARNING: Version check failed, but installation completed. Binary at /usr/local/wkhtmltox/bin/wkhtmltopdf" && \
      ls -la /usr/local/wkhtmltox/bin/wkhtmltopdf)) || true; \
    echo "✓ wkhtmltopdf installation completed"; \
    echo "Creating font cache directories (custom fonts will be loaded via @font-face)..."; \
    mkdir -p /var/cache/fontconfig /home/www-data/.cache/fontconfig && \
    chmod -R 755 /var/cache/fontconfig && \
    echo "✓ Font cache directories created (skipping system font cache - using custom fonts)"; \
    apk del curl tar xz

# 构建期依赖
RUN apk add --no-cache --virtual .build-deps \
    $PHPIZE_DEPS build-base autoconf pkgconfig \
    icu-dev oniguruma-dev libzip-dev libpng-dev postgresql-dev

# 安装扩展
RUN docker-php-ext-install -j$(nproc) \
        pdo pdo_pgsql mbstring intl zip bcmath pcntl \
    && pecl install redis \
    && docker-php-ext-enable redis opcache

# 配置 OPcache
RUN { \
    echo 'opcache.enable=1'; \
    echo 'opcache.enable_cli=1'; \
    echo 'opcache.validate_timestamps=0'; \
    echo 'opcache.memory_consumption=192'; \
    echo 'opcache.interned_strings_buffer=16'; \
    echo 'opcache.max_accelerated_files=100000'; \
} > /usr/local/etc/php/conf.d/opcache.ini

RUN apk del .build-deps

# ---------- Stage 2: 依赖安装 ----------
FROM php-extensions AS deps
WORKDIR /var/www

# Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer
ENV COMPOSER_ALLOW_SUPERUSER=1

# 复制 wkhtmltopdf 文件（如果存在）- 可选
COPY wkhtmltopdf.tar.xz* ./

# 复制 composer 文件（用于缓存）
COPY composer.json composer.lock ./

# ⚠️ 此时不能执行 composer install（没有 artisan）——跳过！
# 我们先复制完整应用，再执行 install

# 复制项目所有代码
COPY . .

# 保证 storage / cache 可写
RUN mkdir -p bootstrap/cache storage/logs \
    && chown -R www-data:www-data bootstrap/cache storage

# ⚠️ 现在 artisan 存在了，安全安装依赖（会跑 scripts）
RUN composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

# ---------- Stage 3: 运行镜像 ----------
FROM php-extensions AS app
WORKDIR /var/www

# 配置上传文件大小
COPY docker/php/uploads.ini /usr/local/etc/php/conf.d/uploads.ini

# 带上 composer
COPY --from=deps /usr/bin/composer /usr/bin/composer

# 验证 wkhtmltopdf 安装
RUN if [ ! -f /usr/local/wkhtmltox/bin/wkhtmltopdf ]; then \
        echo "ERROR: wkhtmltopdf binary not found!"; \
        ls -la /usr/local/wkhtmltox/bin/ 2>/dev/null || echo "Directory does not exist"; \
        exit 1; \
    fi && \
    ls -la /usr/local/bin/wkhtmltopdf* /usr/bin/wkhtmltopdf || true && \
    echo "✓ wkhtmltopdf verified in final image"

# 拷入所有应用 & vendor
COPY --from=deps --chown=www-data:www-data /var/www /var/www

# 可写目录
RUN set -eux; \
    install -d -m 755 -o www-data -g www-data /usr/local/var/run/php

USER www-data
CMD ["php-fpm"]
