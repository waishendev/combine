# ---------- Stage 1: PHP 扩展 ----------
FROM php:8.2-fpm-alpine AS php-extensions
WORKDIR /var/www

# 运行期依赖
# 运行期依赖（加 ffmpeg）
RUN apk add --no-cache \
    icu-libs \
    libzip \
    libpng \
    oniguruma \
    postgresql-libs \
    ffmpeg \
    wkhtmltopdf \
    fontconfig \
    noto-fonts \
    noto-fonts-cjk \
    libx11 \
    libxext \
    libxrender


# 构建期依赖
RUN apk add --no-cache --virtual .build-deps \
    $PHPIZE_DEPS build-base autoconf pkgconfig \
    icu-dev oniguruma-dev libzip-dev libpng-dev postgresql-dev

# 安装扩展
RUN docker-php-ext-install -j$(nproc) \
        pdo pdo_pgsql mbstring intl zip bcmath pcntl \
    && pecl install redis \
    && docker-php-ext-enable redis opcache

# 配置 OPcache
RUN { \
    echo 'opcache.enable=1'; \
    echo 'opcache.enable_cli=1'; \
    echo 'opcache.validate_timestamps=0'; \
    echo 'opcache.memory_consumption=192'; \
    echo 'opcache.interned_strings_buffer=16'; \
    echo 'opcache.max_accelerated_files=100000'; \
} > /usr/local/etc/php/conf.d/opcache.ini

RUN apk del .build-deps

# ---------- Stage 2: 依赖安装 ----------
FROM php-extensions AS deps
WORKDIR /var/www

# Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer
ENV COMPOSER_ALLOW_SUPERUSER=1

# 复制 composer 文件（用于缓存）
COPY composer.json composer.lock ./

# ⚠️ 此时不能执行 composer install（没有 artisan）——跳过！
# 我们先复制完整应用，再执行 install

# 复制项目所有代码
COPY . .

# 保证 storage / cache 可写
RUN mkdir -p bootstrap/cache storage/logs \
    && chown -R www-data:www-data bootstrap/cache storage

# ⚠️ 现在 artisan 存在了，安全安装依赖（会跑 scripts）
RUN composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

# ---------- Stage 3: 运行镜像 ----------
FROM php-extensions AS app
WORKDIR /var/www

# 配置上传文件大小
COPY docker/php/uploads.ini /usr/local/etc/php/conf.d/uploads.ini

# 带上 composer
COPY --from=deps /usr/bin/composer /usr/bin/composer

# 拷入所有应用 & vendor
COPY --from=deps --chown=www-data:www-data /var/www /var/www

# 可写目录
RUN set -eux; \
    install -d -m 755 -o www-data -g www-data /usr/local/var/run/php

USER www-data
CMD ["php-fpm"]
